# Port Magazine 系统设计方案

## 1. 项目概述

基于参考网站 https://www.port-magazine.com/ 的内容管理系统，包含前台展示和后台管理两大模块。

### 1.1 核心功能模块

**前台模块：**
- 首页：展示推文列表
- 推文详情页：展示单篇推文的完整内容

**后台管理模块：**
- 登录认证
- 数据看板（推文看板、广告看板）
- 推文管理（列表、编辑）
- 广告管理（列表、新增）

---

## 2. 技术架构

### 2.1 Monorepo 架构设计

采用 **pnpm workspace** 作为 Monorepo 管理工具，项目结构如下：

```
port/
├── apps/
│   ├── web/              # 前台应用 (Nuxt 3)
│   ├── admin/            # 后台管理应用 (Vue 3 + Vite)
│   └── api/              # 后端 API 服务 (Node.js/Nest.js)
├── packages/
│   ├── ui/               # 共享 Vue 组件库
│   ├── utils/            # 共享工具函数
│   ├── types/            # 共享 TypeScript 类型定义
│   ├── config/           # 共享配置（ESLint, TypeScript, Tailwind 等）
│   └── database/         # 数据库模型和迁移
├── pnpm-workspace.yaml
├── package.json
├── turbo.json            # Turborepo 配置（可选，用于构建优化）
└── README.md
```

### 2.2 技术栈选型

#### 前端技术栈
- **框架**: Vue 3 + Nuxt 3 (前台 SSR) / Vite (后台 SPA)
- **语言**: TypeScript
- **样式**: Tailwind CSS + Element Plus / Naive UI
- **状态管理**: Pinia
- **数据请求**: VueUse + Axios / TanStack Query (Vue)
- **表单处理**: VeeValidate + Zod
- **富文本编辑器**: Tiptap (Vue 版本)

#### 后端技术栈
- **框架**: Nest.js (推荐) 或 Express.js
- **语言**: TypeScript
- **数据库**: PostgreSQL
- **ORM**: Prisma
- **认证**: JWT + Passport.js
- **文件上传**: Multer + 云存储 (AWS S3/阿里云 OSS)
- **缓存**: Redis

#### DevOps & 工具
- **包管理**: pnpm
- **构建工具**: Turbo (可选，加速构建)
- **代码规范**: ESLint + Prettier
- **Git Hooks**: Husky + lint-staged
- **容器化**: Docker + Docker Compose

---

## 3. 数据库设计

### 3.1 核心数据表

#### User (用户表)
```typescript
{
  id: string (UUID)
  email: string (unique)
  password: string (hashed)
  name: string
  role: enum ['admin', 'editor']
  createdAt: DateTime
  updatedAt: DateTime
}
```

#### Post (推文表)
```typescript
{
  id: string (UUID)
  title: string
  slug: string (unique, URL 友好)
  content: JSON (富文本内容)
  excerpt: string (摘要)
  coverImage: string (封面图 URL)
  status: enum ['draft', 'published', 'archived']
  publishedAt: DateTime?
  authorId: string (FK -> User)
  viewCount: number (浏览次数)
  createdAt: DateTime
  updatedAt: DateTime
}
```

#### Advertisement (广告表)
```typescript
{
  id: string (UUID)
  title: string
  imageUrl: string
  linkUrl: string
  position: enum ['banner', 'sidebar', 'inline']
  startDate: DateTime
  endDate: DateTime
  clickCount: number (点击次数)
  impressionCount: number (展示次数)
  status: enum ['active', 'inactive']
  createdAt: DateTime
  updatedAt: DateTime
}
```

#### PostTag (推文标签关联表)
```typescript
{
  postId: string (FK -> Post)
  tagId: string (FK -> Tag)
}
```

#### Tag (标签表)
```typescript
{
  id: string (UUID)
  name: string (unique)
  slug: string (unique)
  createdAt: DateTime
}
```

---

## 4. API 设计

### 4.1 认证相关
- `POST /api/auth/login` - 登录
- `POST /api/auth/logout` - 登出
- `GET /api/auth/me` - 获取当前用户信息

### 4.2 推文管理
- `GET /api/posts` - 获取推文列表（支持分页、筛选、搜索）
- `GET /api/posts/:id` - 获取推文详情
- `POST /api/posts` - 创建推文
- `PUT /api/posts/:id` - 更新推文
- `DELETE /api/posts/:id` - 删除推文
- `PATCH /api/posts/:id/publish` - 发布推文
- `GET /api/posts/stats` - 获取推文统计数据

### 4.3 广告管理
- `GET /api/ads` - 获取广告列表
- `GET /api/ads/:id` - 获取广告详情
- `POST /api/ads` - 创建广告
- `PUT /api/ads/:id` - 更新广告
- `DELETE /api/ads/:id` - 删除广告
- `GET /api/ads/stats` - 获取广告统计数据

### 4.4 文件上传
- `POST /api/upload/image` - 上传图片

---

## 5. 前端页面设计

### 5.1 前台应用 (apps/web)

#### 技术方案
- **框架**: Nuxt 3 (支持 SSR/SSG)
- **UI 库**: Tailwind CSS + 自定义组件
- **状态管理**: Pinia
- **数据获取**: useFetch / useAsyncData (Nuxt 内置)

#### 路由结构
```
/                    # 首页（推文列表）
/posts/:slug         # 推文详情页
/about               # 关于页面（可选）
```

#### 核心组件
- `PostCard.vue` - 推文卡片
- `PostDetail.vue` - 推文详情
- `AppHeader.vue` - 页头导航
- `AppFooter.vue` - 页脚
- `AdBanner.vue` - 广告横幅

#### 目录结构
```
apps/web/
├── components/          # 组件
├── composables/         # 组合式函数
├── layouts/             # 布局
├── pages/               # 页面（自动路由）
├── public/              # 静态资源
├── server/              # 服务端 API（可选）
├── stores/              # Pinia 状态管理
├── app.vue              # 根组件
└── nuxt.config.ts       # Nuxt 配置
```

### 5.2 后台管理应用 (apps/admin)

#### 技术方案
- **框架**: Vue 3 + Vite
- **UI 库**: Element Plus 或 Naive UI
- **路由**: Vue Router
- **状态管理**: Pinia
- **数据请求**: Axios + VueUse

#### 路由结构
```
/login                    # 登录页
/dashboard                # 数据看板
/dashboard/posts          # 推文看板
/dashboard/ads            # 广告看板
/posts                    # 推文管理列表
/posts/new                # 新建推文
/posts/:id/edit           # 编辑推文
/ads                      # 广告管理列表
/ads/new                  # 新建广告
/ads/:id/edit             # 编辑广告
```

#### 核心组件
- `LoginForm.vue` - 登录表单
- `DashboardCard.vue` - 数据卡片
- `PostTable.vue` - 推文列表表格
- `PostEditor.vue` - 推文编辑器
- `AdTable.vue` - 广告列表表格
- `AdForm.vue` - 广告表单
- `LayoutSidebar.vue` - 侧边栏导航
- `LayoutTopBar.vue` - 顶部栏

#### 目录结构
```
apps/admin/
├── src/
│   ├── assets/          # 静态资源
│   ├── components/      # 组件
│   ├── composables/     # 组合式函数
│   ├── layouts/         # 布局组件
│   ├── pages/           # 页面组件
│   ├── router/          # 路由配置
│   ├── stores/          # Pinia 状态管理
│   ├── utils/           # 工具函数
│   ├── App.vue          # 根组件
│   └── main.ts          # 入口文件
├── index.html
└── vite.config.ts       # Vite 配置
```

---

## 6. 共享包设计

### 6.1 packages/ui
共享 Vue 组件库，基于 Element Plus 或 Naive UI 二次封装：
- Button, Input, Select, Dialog 等基础组件
- DataTable - 数据表格组件
- Form - 表单组件
- Card - 卡片组件

**组件示例**：
```vue
<!-- packages/ui/src/components/Button.vue -->
<template>
  <button :class="buttonClass" @click="handleClick">
    <slot />
  </button>
</template>

<script setup lang="ts">
import { computed } from 'vue'

interface Props {
  type?: 'primary' | 'secondary' | 'danger'
  size?: 'small' | 'medium' | 'large'
}

const props = withDefaults(defineProps<Props>(), {
  type: 'primary',
  size: 'medium'
})

const emit = defineEmits<{
  click: [event: MouseEvent]
}>()

const buttonClass = computed(() => {
  return `btn btn-${props.type} btn-${props.size}`
})

const handleClick = (event: MouseEvent) => {
  emit('click', event)
}
</script>
```

### 6.2 packages/types
共享 TypeScript 类型定义：
```typescript
// 用户类型
export interface User {
  id: string;
  email: string;
  name: string;
  role: 'admin' | 'editor';
}

// 推文类型
export interface Post {
  id: string;
  title: string;
  slug: string;
  content: any;
  excerpt: string;
  coverImage: string;
  status: 'draft' | 'published' | 'archived';
  publishedAt?: Date;
  author: User;
  viewCount: number;
  createdAt: Date;
  updatedAt: Date;
}

// 广告类型
export interface Advertisement {
  id: string;
  title: string;
  imageUrl: string;
  linkUrl: string;
  position: 'banner' | 'sidebar' | 'inline';
  startDate: Date;
  endDate: Date;
  clickCount: number;
  impressionCount: number;
  status: 'active' | 'inactive';
}
```

### 6.3 packages/utils
共享工具函数和 Vue 组合式函数：

**工具函数**：
- `formatDate` - 日期格式化
- `slugify` - 生成 URL 友好的 slug
- `truncate` - 文本截断
- `validateEmail` - 邮箱验证
- API 请求封装

**Vue Composables**：
```typescript
// packages/utils/src/composables/useAuth.ts
import { ref, computed } from 'vue'
import type { User } from '@port/types'

export function useAuth() {
  const user = ref<User | null>(null)
  const isAuthenticated = computed(() => !!user.value)
  
  const login = async (email: string, password: string) => {
    // 登录逻辑
  }
  
  const logout = async () => {
    // 登出逻辑
  }
  
  return {
    user,
    isAuthenticated,
    login,
    logout
  }
}
```

```typescript
// packages/utils/src/composables/usePagination.ts
import { ref, computed } from 'vue'

export function usePagination(initialPage = 1, initialPageSize = 10) {
  const currentPage = ref(initialPage)
  const pageSize = ref(initialPageSize)
  const total = ref(0)
  
  const totalPages = computed(() => Math.ceil(total.value / pageSize.value))
  
  const goToPage = (page: number) => {
    if (page >= 1 && page <= totalPages.value) {
      currentPage.value = page
    }
  }
  
  return {
    currentPage,
    pageSize,
    total,
    totalPages,
    goToPage
  }
}
```

### 6.4 packages/database
Prisma schema 和数据库迁移文件

---

## 7. 部署方案

### 7.1 开发环境
```bash
# 安装依赖
pnpm install

# 启动数据库（Docker）
docker-compose up -d

# 运行数据库迁移
pnpm --filter @port/database db:migrate

# 启动所有应用
pnpm dev

# 或分别启动
pnpm --filter @port/web dev
pnpm --filter @port/admin dev
pnpm --filter @port/api dev
```

### 7.2 生产环境

**方案一：传统部署**
- 前端 Web：Vercel / Netlify（Nuxt 3 支持）
- 前端 Admin：Nginx 静态托管
- 后端：AWS EC2 / 阿里云 ECS
- 数据库：AWS RDS / 阿里云 RDS

**方案二：容器化部署**
- Docker + Docker Compose
- Kubernetes (适合大规模)

**方案三：Serverless**
- 前端 Web：Vercel（Nuxt 3 支持）
- 前端 Admin：Vercel / Netlify
- 后端：AWS Lambda / 阿里云函数计算

---

## 8. 安全考虑

### 8.1 认证与授权
- JWT Token 认证
- HTTP-only Cookie 存储 Token
- RBAC 角色权限控制
- API 路由守卫

### 8.2 数据安全
- 密码使用 bcrypt 加密
- SQL 注入防护（Prisma ORM）
- XSS 防护（内容过滤）
- CSRF 防护

### 8.3 文件上传安全
- 文件类型验证
- 文件大小限制
- 文件名随机化
- 使用云存储服务

---

## 9. 性能优化

### 9.1 前端优化
- Nuxt 3 SSR/SSG（前台）
- Vite 构建优化（后台）
- 图片懒加载和优化
- 组件懒加载（defineAsyncComponent）
- 路由懒加载
- CDN 加速

### 9.2 后端优化
- Redis 缓存热点数据
- 数据库索引优化
- API 响应压缩
- 分页查询

### 9.3 构建优化
- Turbo 并行构建
- 增量构建
- 依赖缓存

---

## 10. 开发规范

### 10.1 代码规范
- ESLint + Prettier
- TypeScript 严格模式
- Git commit 规范（Conventional Commits）

### 10.2 分支管理
- `main` - 生产环境
- `develop` - 开发环境
- `feature/*` - 功能分支
- `hotfix/*` - 紧急修复分支

### 10.3 测试策略
- 单元测试：Vitest + Vue Test Utils
- E2E 测试：Playwright / Cypress
- API 测试：Supertest

---

## 11. 项目初始化步骤

### 11.1 创建 Monorepo 结构
```bash
# 初始化项目
mkdir port && cd port
pnpm init

# 创建 workspace 配置
echo "packages:\n  - 'apps/*'\n  - 'packages/*'" > pnpm-workspace.yaml

# 创建目录结构
mkdir -p apps/{web,admin,api}
mkdir -p packages/{ui,utils,types,config,database}
```

### 11.2 安装依赖
```bash
# 根目录安装开发依赖
pnpm add -D -w typescript @types/node turbo

# 前台应用（Nuxt 3）
cd apps/web
pnpm init
pnpm add nuxt vue
pnpm add -D @nuxt/devtools

# 后台应用（Vue 3 + Vite）
cd ../admin
pnpm init
pnpm add vue vue-router pinia
pnpm add -D vite @vitejs/plugin-vue

# API 服务
cd ../api
pnpm init
pnpm add @nestjs/core @nestjs/common @nestjs/platform-express
```

### 11.3 配置 TypeScript
在根目录创建 `tsconfig.json` 基础配置，各子包继承。

---

## 12. 后续扩展

### 12.1 功能扩展
- 评论系统
- 用户订阅/通知
- 多语言支持
- SEO 优化
- 搜索功能（Elasticsearch）

### 12.2 技术扩展
- 微前端架构（Module Federation）
- GraphQL API
- WebSocket 实时通信
- 数据分析和报表

---

## 13. 总结

本设计方案采用 Monorepo 架构，具有以下优势：

✅ **代码复用**：共享组件、类型、工具函数  
✅ **统一管理**：统一的依赖管理和构建流程  
✅ **类型安全**：TypeScript 全栈类型共享  
✅ **开发效率**：快速迭代，减少重复工作  
✅ **可扩展性**：易于添加新应用和包  

该方案为 Port Magazine 系统提供了清晰的技术架构和实施路径，可根据实际需求进行调整和优化。
