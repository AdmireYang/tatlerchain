// Prisma Schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// 用户表
model User {
  id        String   @id @default(uuid())
  email     String   @unique
  password  String
  name      String
  role      Role     @default(EDITOR)
  posts     Post[]
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("users")
}

enum Role {
  ADMIN
  EDITOR
}

// 推文表
model Post {
  id             String              @id @default(uuid())
  title          String              @db.VarChar(50)  // 限制50字符
  slug           String              @unique          // 路径唯一
  content        Json
  excerpt        String                               // 描述
  category       String                               // 分类（必填）
  coverImage     String                               // 封面图片（列表用）
  detailImage    Json?                                // 详情首图（包含 url, authorName, authorLink）
  status         PostStatus          @default(DRAFT)
  publishedAt    DateTime?
  authorId       String
  author         User                @relation(fields: [authorId], references: [id])
  viewCount      Int                 @default(0)
  advertisements PostAdvertisement[]                  // 广告（非必填）
  createdAt      DateTime            @default(now())
  updatedAt      DateTime            @updatedAt

  @@index([category])
  @@map("posts")
}

enum PostStatus {
  DRAFT //草稿
  PUBLISHED //发布
  ARCHIVED //归档
}

// 广告表
model Advertisement {
  id               String              @id @default(uuid())
  title            String              @db.VarChar(50)  // 限制50字符
  category         String                               // 分类（必填）
  imageUrl         String
  linkUrl          String
  clickCount       Int                 @default(0)
  impressionCount  Int                 @default(0)
  status           AdStatus            @default(ACTIVE)
  publishedAt      DateTime?                            // 发布时间
  posts            PostAdvertisement[]
  createdAt        DateTime            @default(now())
  updatedAt        DateTime            @updatedAt

  @@index([category])
  @@index([publishedAt])
  @@map("advertisements")
}

// 推文广告关联表
model PostAdvertisement {
  postId          String
  advertisementId String
  sortOrder       Int            @default(0)  // 排序
  post            Post           @relation(fields: [postId], references: [id], onDelete: Cascade)
  advertisement   Advertisement  @relation(fields: [advertisementId], references: [id], onDelete: Cascade)

  @@id([postId, advertisementId])
  @@map("post_advertisements")
}

enum AdStatus {
  ACTIVE
  INACTIVE
}

// API 日志表
model ApiLog {
  id           String   @id @default(uuid())
  method       String   // GET, POST, PUT, DELETE
  path         String   // 请求路径
  statusCode   Int      // 响应状态码
  duration     Int      // 响应耗时(ms)
  userId       String?  // 用户ID（可选）
  userEmail    String?  // 用户邮箱（可选）
  ip           String?  // 客户端IP
  userAgent    String?  // User-Agent
  requestBody  Json?    // 请求体（可选，敏感信息需过滤）
  errorMessage String?  // 错误信息
  createdAt    DateTime @default(now())

  @@index([path])
  @@index([userId])
  @@index([createdAt])
  @@map("api_logs")
}

// 埋点事件表
model TrackEvent {
  id           String         @id @default(uuid())
  code         String         // 功能点标识码
  type         TrackEventType // 事件类型：曝光、离开、点击
  pagePath     String         // 页面路径
  pageTitle    String?        // 页面标题
  referrer     String?        // 来源页面
  
  // 设备信息
  deviceId     String?        // 设备唯一标识
  deviceType   String?        // 设备类型：mobile/tablet/desktop
  os           String?        // 操作系统
  osVersion    String?        // 系统版本
  browser      String?        // 浏览器
  browserVersion String?      // 浏览器版本
  screenWidth  Int?           // 屏幕宽度
  screenHeight Int?           // 屏幕高度
  
  // 用户信息
  userId       String?        // 登录用户ID（可选）
  sessionId    String?        // 会话ID
  ip           String?        // 客户端IP
  
  // 扩展数据
  extra        Json?          // 额外数据（如：按钮文案、商品ID等）
  duration     Int?           // 停留时长（离开事件用，单位ms）
  
  createdAt    DateTime       @default(now())

  @@index([code])
  @@index([type])
  @@index([pagePath])
  @@index([userId])
  @@index([deviceId])
  @@index([createdAt])
  @@map("track_events")
}

enum TrackEventType {
  EXPOSURE   // 曝光
  LEAVE      // 离开
  CLICK      // 点击
}